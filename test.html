<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Bananagrams Solver Tests</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:16px}
    .pass{color:green}
    .fail{color:red}
    pre{background:#f6f8fa;padding:8px;border-radius:6px}
  </style>
</head>
<body>
  <h1>Bananagrams - quick tests</h1>
  <div id="results">Running tests...</div>
  <h2>Benchmarks</h2>
  <div>
    <button id="run-bench">Run benchmarks</button>
    <div id="bench-results"></div>
  </div>

  <script src="compressedTrie.js"></script>
  <script src="solver.js"></script>
  <script>
    const results = [];

    function assert(name, cond, info) {
      results.push({name, ok: !!cond, info});
    }

    try {
      assert('trieLoaded', typeof trie === 'object', 'trie should be an object');

      // test getLetterCounts
      const c1 = getLetterCounts('aabz');
      assert('getLetterCounts aabz', c1[0] === 2 && c1[25] === 1, 'counts a/z');

      // test narrowWordsBy with a small wordlist
      const sampleWords = ['cat','bat','at','tab'];
      const narrowed = narrowWordsBy(sampleWords, 'tac');
      assert('narrowWordsBy tac', Array.isArray(narrowed) && narrowed.includes('cat'), 'should include cat');

      // test getPattern returns RegExp
      const pattern = getPattern([' a b ']);
      assert('getPattern returns RegExp', pattern instanceof RegExp, String(pattern));

      // test getIndexOfWordInStripLoop impossible placement
      const strip = [' ',' ',' '];
      const idx = getIndexOfWordInStripLoop(/x/, ['x'], strip, 'first');
      assert('getIndexOfWordInStripLoop no match', idx === false, 'should be false');

      // smoke-run makeWordsWith to ensure it doesn't throw
      const words = makeWordsWith('abc', trie, []);
      assert('makeWordsWith returns array', Array.isArray(words), 'words length ' + words.length);

    } catch (e) {
      results.push({name:'exception', ok:false, info: String(e)});
    }

    const out = document.getElementById('results');
    out.innerHTML = results.map(r => `<div class="${r.ok?'pass':'fail'}">${r.ok? 'PASS':'FAIL'}: ${r.name} ${r.info? '- '+r.info: ''}</div>`).join('');

    // Benchmark harness
    const benchBtn = document.getElementById('run-bench');
    const benchOut = document.getElementById('bench-results');
    const benches = [
      'abcdefg',
      'trains',
      'qwertyui',
      'stoplearn',
      'abcdefghijklmnopqrstuvwxyz'.slice(0, 12)
    ];

    benchBtn.addEventListener('click', async () => {
      benchBtn.disabled = true;
      benchOut.innerHTML = 'Running...';
      const results = [];
      for (const letters of benches) {
        const t0 = performance.now();
        const dur = await runSolveOnce(letters);
        const t1 = performance.now();
        results.push({ letters, dur: dur || (t1 - t0) });
      }
      benchOut.innerHTML = results.map(r => `<div>${r.letters}: ${r.dur.toFixed(1)} ms</div>`).join('');
      benchBtn.disabled = false;
    });

    function runSolveOnce(letters) {
      return new Promise((resolve) => {
        // Give a small amount of time for UI to update
        setTimeout(() => {
          const t0 = performance.now();
          let resolved = false;
          // Use a timeout to prevent extremely long runs from hanging the bench
          const timer = setTimeout(() => {
            if (!resolved) {
              resolved = true;
              resolve(performance.now() - t0);
            }
          }, 10000);
          try {
            solve(letters, [], trie, ({ end }) => {
              if (end && !resolved) {
                resolved = true;
                clearTimeout(timer);
                resolve(performance.now() - t0);
              }
              return true;
            });
          } catch (e) {
            if (!resolved) {
              resolved = true;
              clearTimeout(timer);
              resolve(null);
            }
          }
        }, 10);
      });
    }
  </script>
</body>
</html>